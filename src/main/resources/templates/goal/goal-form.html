<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ëª©í‘œ ì„¤ì •</title>
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/goal.css">
  <link rel="stylesheet" href="/css/header.css">

  <script src="/js/feedback-notify.js"></script>

  <script src="/js/notification.js" defer></script>

</head>



<body>
<header th:replace="fragments/header :: header"></header>

<main>
  <section class="goal-form-container">
    <h2>í•™ìŠµ ëª©í‘œë¥¼ ì„¤ì •í•´ë³´ì„¸ìš”!</h2>
    <p style="color: #888; font-size: 0.9rem; margin-top: -10px">
      ëª©í‘œëŠ” ì¼ì¼ ë‹¨ìœ„ë¡œ ì„¤ì •ë˜ë©°, ì¼ì§€ ì‘ì„± ì‹œ ìë™ìœ¼ë¡œ ì—°ë™ë©ë‹ˆë‹¤.
    </p>

    <form th:action="@{/goals/create}" th:object="${goalCreateDTO}" method="post">
      <!-- ìˆ˜ì • ëª¨ë“œì¼ ë•Œë§Œ goalId ì“°ë„ë¡ -->
      <input type="hidden" id="repeatValueHidden" name="repeatValue" th:field="*{repeatValue}" />
      <input type="hidden" th:field="*{createdValue}" id="createdValue" />


      <!-- ë‚ ì§œ ìë™ ìƒì„± -->
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <label for="title" style="margin-bottom: 0;">ëª©í‘œ</label>
        <span id="displayDate" class="small-gray-text"></span>
      </div>

      <input type="text" th:field="*{title}" id="title" placeholder="ëª©í‘œë¥¼ ì…ë ¥í•˜ì„¸ìš”" required />

      <label>ë°˜ë³µ ì„¤ì •</label>
      <div class="repeat-options">
        <label><input type="radio" th:field="*{repeatType}" value="DAILY" checked> ë§¤ì¼</label>
        <label><input type="radio" th:field="*{repeatType}" value="WEEKLY"> ì£¼ 3íšŒ</label>
        <label><input type="radio" th:field="*{repeatType}" value="CUSTOM"> ì‚¬ìš©ì ì§€ì •</label>
      </div>

      <div id="repeatValueInput" style="display: none;">
        <label for="repeatValue">ë°˜ë³µ íšŸìˆ˜</label>
        <div style="display: flex; align-items: center; gap: 6px;">
          <span>ì£¼</span>
          <input
                  type="text"
                  id="repeatValue"
                  style="width: 80px; padding: 4px;"
                  inputmode="numeric"
                  pattern="[1-6]"
                  maxlength="1"
          />
          <span>íšŒ</span>
        </div>
        <small style="color: #999;">1~6 ì‚¬ì´ ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.</small>
      </div>

      <label>ì¹´í…Œê³ ë¦¬</label>
      <select id="category" th:field="*{categoryId}" required>
        <option th:each="c : ${categories}" th:value="${c.id}" th:text="${c.name}"></option>
      </select>


      <div class="form-group">
        <label for="goalDetail" class="form-label">ëª©í‘œ ìƒì„¸ ì„¤ëª… (ì„ íƒì‚¬í•­)</label>
        <textarea id="goalDetail" name="goalDetail" th:field="*{goalDetail}" class="form-textarea"
                  placeholder="ì´ë²ˆ ì£¼ í•™ìŠµí•  ë‚´ìš©ì´ë‚˜ ë°©ì‹ì— ëŒ€í•œ êµ¬ì²´ì ì¸ ì„¤ëª…ì„ ì ì–´ë³´ì„¸ìš”"></textarea>
      </div>

      <div class="form-group">
        <label for="goalReason" class="form-label">ì´ ëª©í‘œë¥¼ ì„¤ì •í•œ ì´ìœ ëŠ” ë¬´ì—‡ì¸ê°€ìš”? (ì„ íƒì‚¬í•­)</label>
        <textarea id="goalReason" name="goalReason" th:field="*{goalReason}" class="form-textarea"
                  placeholder="ì˜ˆ:ì‹œí—˜ ëŒ€ë¹„, ê°œë… ë³´ì™„, ìê¸°ì£¼ë„ í•™ìŠµ ë“±"></textarea>
      </div>


      <!-- ğŸ”¹ ì„ í˜¸ í•™ìŠµ ë°©ì‹ -->
      <div class="form-section">
        <label>ì„ í˜¸í•˜ëŠ” í•™ìŠµ ë°©ì‹</label>
        <div>
          <label><input type="radio" th:field="*{learningStyle}" value="ì´ë¡  ì¤‘ì‹¬"> ì´ë¡  ì¤‘ì‹¬</label>
          <label><input type="radio" th:field="*{learningStyle}" value="ì‹¤ìŠµ ì¤‘ì‹¬"> ì‹¤ìŠµ ì¤‘ì‹¬</label>
          <label><input type="radio" th:field="*{learningStyle}" value="ë¬¸ì œí’€ì´ ì¤‘ì‹¬"> ë¬¸ì œí’€ì´ ì¤‘ì‹¬</label>
        </div>
      </div>


      <button type="submit" class="button save-btn">ì €ì¥</button>
    </form>
  </section>


  <section class="goal-list-wrapper">
    <div id="goal-list-container">
      <div th:each="goal, iterStat : ${goals}"
           th:class="'goal-card color-' + ${iterStat.index % 3}"
           th:style="${goal.isCompleted} ? 'opacity: 0.5;' : ''"
           th:attr="data-id=${goal.id},
              data-title=${goal.title},
              data-repeattype=${goal.repeatType},
              data-repeatvalue=${goal.repeatValue},
              data-categoryid=${goal.categoryId},
              data-completed=${goal.isCompleted},
              data-goaldetail=${goal.goalDetail},
              data-goalreason=${goal.goalReason},
              data-learningstyle=${goal.learningStyle}">


        <div class="goal-header">
          <div class="goal-left">
            <div class="goal-title" th:text="${goal.title}"></div>
            <div class="goal-meta">
              <span th:text="${goal.createdValue}"></span>
              <span th:if="${goal.repeatType == 'DAILY'}"> Â· ë°˜ë³µ: ë§¤ì¼</span>
              <span th:if="${goal.repeatType == 'WEEKLY'}"> Â· ë°˜ë³µ: ì£¼ 3íšŒ</span>
              <span th:if="${goal.repeatType == 'CUSTOM'}" th:text="' Â· ë°˜ë³µ: ì£¼ ' + ${goal.repeatValue} + 'íšŒ'"></span>
            </div>
          </div>
          <div class="goal-category" th:text="${goal.categoryName + ' / ' + (goal.learningStyle != null ? goal.learningStyle : 'ë¯¸ì§€ì •')}"></div>
        </div>

        <div class="goal-percent" th:text="${goal.progress + '%'}"></div>
        <div class="progress-bar">
          <div class="progress" th:style="'width:' + ${goal.progress} + '%' "></div>
        </div>
        <div class="goal-actions">
          <button class="button edit-btn" th:disabled="${goal.isCompleted}">ìˆ˜ì •</button>
          <button class="button delete-btn" th:text="${goal.isCompleted} ? 'ì¢…ë£Œë¨' : 'ì¢…ë£Œ'" th:disabled="${goal.isCompleted}">ì¢…ë£Œ</button>
          <button class="button remove-btn">ì‚­ì œ</button>
        </div>
      </div>
    </div>
  </section>

  <div class="load-more-wrapper">
    <button id="loadMore" class="button load-more">ì´ì „ ëª©í‘œ ë”ë³´ê¸°</button>
  </div>
</main>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // ë‚ ì§œ ìë™ ì„¤ì •
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('createdValue').value = today;
    document.getElementById('displayDate').innerText = today;

    // ë°˜ë³µ íƒ€ì…ì— ë”°ë¼ ë°˜ë³µíšŸìˆ˜ ì…ë ¥ì¹¸ í‘œì‹œ
    const repeatRadios = document.querySelectorAll('input[name="repeatType"]');
    const repeatInput = document.getElementById('repeatValueInput');
    const repeatValueField = document.getElementById("repeatValueHidden");

    repeatRadios.forEach(radio => {
      radio.addEventListener('change', () => {
        if (radio.value === "CUSTOM" && radio.checked) {
          repeatInput.style.display = 'block';
          repeatValueField.value = "";
        } else if (radio.checked) {
          repeatInput.style.display = 'none';
          repeatValueField.value = radio.value === "WEEKLY" ? "3" : "ALL";
        }
      });

      if (radio.checked) {
        radio.dispatchEvent(new Event("change"));
      }
    });

    const customRepeat = document.getElementById('repeatValue');
    if (customRepeat) {
      customRepeat.addEventListener('input', () => {
        repeatValueField.value = customRepeat.value;
      });
    }

    // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ í¼ì— ê°’ ì±„ìš°ê¸°
    document.addEventListener('click', function (e) {
      if (e.target.classList.contains('edit-btn')) {
        const goalCard = e.target.closest('.goal-card');

        const id = goalCard.getAttribute("data-id");
        const title = goalCard.getAttribute("data-title");
        const repeatType = goalCard.getAttribute("data-repeattype");
        const repeatValue = goalCard.getAttribute("data-repeatvalue");
        const categoryId = goalCard.getAttribute("data-categoryid");

        document.querySelector("#title").value = title;
        document.querySelector(`input[name='repeatType'][value='${repeatType}']`).checked = true;


        const repeatInputBlock = document.querySelector("#repeatValueInput");
        const repeatValueHidden = document.querySelector("#repeatValueHidden");
        const repeatValueVisible = document.querySelector("#repeatValue");

        const goalDetail = goalCard.getAttribute("data-goaldetail");
        const goalReason = goalCard.getAttribute("data-goalreason");
        const learningStyle = goalCard.getAttribute("data-learningstyle");

        document.querySelector("#goalDetail").value = goalDetail;
        document.querySelector("#goalReason").value = goalReason;

        if (learningStyle) {
          const styleRadio = document.querySelector(`input[name='learningStyle'][value='${learningStyle}']`);
          if (styleRadio) styleRadio.checked = true;
        }


        if (repeatType === "CUSTOM") {
          repeatInputBlock.style.display = "block";
          repeatValueVisible.value = repeatValue;
          repeatValueHidden.value = repeatValue;
        } else {
          repeatInputBlock.style.display = "none";
          repeatValueHidden.value = repeatType === "WEEKLY" ? "3" : "ALL";
        }

        document.querySelector("#category").value = categoryId;

        let goalIdInput = document.querySelector("input[name='goalId']");
        if (!goalIdInput) {
          goalIdInput = document.createElement("input");
          goalIdInput.type = "hidden";
          goalIdInput.name = "goalId";
          goalIdInput.id = "goalId";
          document.querySelector("form").appendChild(goalIdInput);
        }
        goalIdInput.value = id;
      }
    });

    // ì¢…ë£Œ ì²˜ë¦¬
    document.addEventListener('click', function (e) {
      if (e.target.classList.contains('delete-btn')) {
        const goalCard = e.target.closest('.goal-card');
        const goalId = goalCard.getAttribute('data-id');

        fetch(`/api/goals/${goalId}/complete`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' }
        })
                .then(response => {
                  if (!response.ok) throw new Error('ì¢…ë£Œ ì‹¤íŒ¨');
                  return response.text();
                })
                .then(() => {
                  e.target.disabled = true;
                  e.target.innerText = 'ì¢…ë£Œë¨';
                  goalCard.style.opacity = '0.5';
                  const editBtn = goalCard.querySelector('.edit-btn');
                  if (editBtn) editBtn.disabled = true;
                  goalCard.setAttribute('data-completed', 'true');
                })
                .catch(err => {
                  alert('ì¢…ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨: ' + err.message);
                });
      }
    });

    // âœ… ì‚­ì œ ì²˜ë¦¬ ì¶”ê°€
    document.addEventListener('click', function (e) {
      if (e.target.classList.contains('remove-btn')) {
        const goalCard = e.target.closest('.goal-card');
        const goalId = goalCard.getAttribute('data-id');

        if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          fetch(`/api/goals/${goalId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
          })
                  .then(response => {
                    if (!response.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨');
                    return response.text();
                  })
                  .then(() => {
                    goalCard.remove();

                    // ì‚­ì œ í›„ ë³´ì´ëŠ” ëª©í‘œ ê°œìˆ˜ í™•ì¸
                    const remaining = document.querySelectorAll('.goal-card').length;

                    if (remaining < 5 && loadBtn.innerText !== 'ëª©ë¡ ê°„ì†Œí™”í•˜ê¸°') {
                      loadMoreGoals(); // ì•„ë˜ì— ì •ì˜
                    }
                  })

                  .catch(err => {
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + err.message);
                  });
        }
      }
    });

    // âœ… ë”ë³´ê¸° + ê°„ì†Œí™” í†µí•© ì²˜ë¦¬
    let lastGoalId = null;
    let isLoading = false;
    const loadBtn = document.getElementById('loadMore');

    function simplifyGoalList() {
      const allGoals = document.querySelectorAll('.goal-card');
      allGoals.forEach((card, index) => {
        if (index >= 5) card.remove();
      });
      loadBtn.innerText = 'ì´ì „ ëª©í‘œ ë”ë³´ê¸°';
      lastGoalId = null;
    }

    async function loadMoreGoals() {
      if (isLoading) return;
      isLoading = true;

      try {
        const response = await fetch(`/api/goals/list?cursor=${lastGoalId ?? ''}`);
        const data = await response.json();

        data.forEach(goal => {
          if (document.querySelector(`.goal-card[data-id="${goal.id}"]`)) return;

          const div = document.createElement('div');
          div.className = 'goal-card';
          div.setAttribute('data-id', goal.id);
          div.setAttribute('data-title', goal.title);
          div.setAttribute('data-repeattype', goal.repeatType);
          div.setAttribute('data-repeatvalue', goal.repeatValue);
          div.setAttribute('data-categoryid', goal.categoryId);
          div.setAttribute('data-completed', goal.isCompleted);

          div.setAttribute('data-goaldetail', goal.goalDetail);
          div.setAttribute('data-goalreason', goal.goalReason);
          div.setAttribute('data-learningstyle', goal.learningStyle);

          div.innerHTML = `
  <div class="goal-header">
    <div class="goal-left">
      <div class="goal-title">${goal.title}</div>
      <div class="goal-meta">
        <span>${goal.createdValue}</span>
        <span>${
                  goal.repeatType === 'DAILY' ? ' Â· ë°˜ë³µ: ë§¤ì¼' :
                          goal.repeatType === 'WEEKLY' ? ' Â· ë°˜ë³µ: ì£¼ 3íšŒ' :
                                  ` Â· ë°˜ë³µ: ì£¼ ${goal.repeatValue}íšŒ`
          }</span>
      </div>
    </div>
    <div class="goal-right">
      <div class="goal-category">${goal.categoryName} / ${goal.learningStyle || 'ë¯¸ì§€ì •'}</div>
    </div>
  </div>
  <div class="goal-percent">${goal.progress}%</div>
  <div class="progress-bar">
    <div class="progress" style="width:${goal.progress}%;"></div>
  </div>
  <div class="goal-actions">
    <button class="button edit-btn" ${goal.isCompleted ? 'disabled' : ''}>ìˆ˜ì •</button>
    <button class="button delete-btn" ${goal.isCompleted ? 'disabled' : ''}>
      ${goal.isCompleted ? 'ì¢…ë£Œë¨' : 'ì¢…ë£Œ'}
    </button>
    <button class="button remove-btn" ${goal.isCompleted ? 'disabled' : ''}>ì‚­ì œ</button>
  </div>
`;


          document.getElementById('goal-list-container').appendChild(div);
        });

        if (data.length > 0) {
          lastGoalId = data[data.length - 1].id;
        }

        if (data.length < 5) {
          loadBtn.innerText = 'ëª©ë¡ ê°„ì†Œí™”í•˜ê¸°';
        }

      } catch (error) {
        console.error('ëª©í‘œ ë”ë³´ê¸° ì‹¤íŒ¨:', error);
      }

      isLoading = false;
    }

    loadBtn.addEventListener('click', () => {
      if (loadBtn.innerText === 'ëª©ë¡ ê°„ì†Œí™”í•˜ê¸°') {
        simplifyGoalList();
      } else {
        loadMoreGoals();
      }
    });


    document.querySelector("form").addEventListener("submit", async function (e) {
      const goalIdInput = document.getElementById("goalId");

      if (goalIdInput) {
        // ìˆ˜ì • ëª¨ë“œì¸ ê²½ìš° PATCH ìš”ì²­
        e.preventDefault();

        const goalId = goalIdInput.value;
        const title = document.querySelector("#title").value;
        const repeatType = document.querySelector("input[name='repeatType']:checked").value;
        const repeatValue = document.querySelector("#repeatValueHidden").value;
        const categoryId = document.querySelector("#category").value;
        const goalDetail = document.querySelector("#goalDetail").value;
        const goalReason = document.querySelector("#goalReason").value;
        const learningStyleInput = document.querySelector("input[name='learningStyle']:checked");
        const learningStyle = learningStyleInput ? learningStyleInput.value : null;

        const body = {
          goalId: parseInt(goalId),
          title,
          repeatType,
          repeatValue,
          categoryId: parseInt(categoryId),
          goalDetail,
          goalReason,
          learningStyle
        };

        try {
          const res = await fetch(`/api/goals/${goalId}`, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(body)
          });

          if (res.ok) {
            alert("ëª©í‘œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.reload();
          } else {
            alert("ìˆ˜ì • ì‹¤íŒ¨: " + (await res.text()));
          }
        } catch (err) {
          alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message);
        }
      }
    });



  });
</script>

</body>
</html>
